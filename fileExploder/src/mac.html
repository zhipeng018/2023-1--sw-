<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="mac.css" />
    <title>Document</title>
</head>
<body>
    <div class = "header">
        <h1>
          <img src="./resources/logo.PNG" id = "logo" alt="logo" height="70" width="=180" >
          <button class="login" onclick="signin()"></button>
          <script>
            function signin(){
              window.open('login.html',"Sign in","wdith=420,height=420");  
            }
          </script>
        </h1>
    </div>
    <div class="file_List">
      <div class="navbar">
        <ul>
          <li>
            <button id="backButton">Back</button>
            <script>
              backButton.addEventListener('click', () => {
                const currentPath = fileList.getAttribute('data-path');
                const parentPath = path.dirname(currentPath);
                if(parentPath !== '/'){
                  updateFileList(parentPath);
                }
              })
            </script>
          </li>
          <li>
            <button id="createFile">add</button>
            <script id="file-add.js">
            </script>
          </li>
          <li><button id="delete">delete</button></li>
          <li>
            <button id="git">git</button>
            <script id="git.js">
              document.getElementById("git").addEventListener("click", function() {
                const git = require('\\2023-1--sw-\\fileExploder\\src\\git\\git.js');
          
                git.clone()
                  .then(() => {
                    console.log('Repository cloned successfully');
                    return git.add('file.txt');
                  })
                  .then(() => {
                    console.log('File added successfully');
                    return git.commit('Add file');
                  })
                  .then(() => {
                    console.log('Changes committed successfully');
                    return git.push();
                  })
                  .then(() => {
                    console.log('Changes pushed successfully');
                    return git.pull();
                  })
                  .then(() => {
                    console.log('Changes pulled successfully');
                  })
                  .catch((error) => {
                    console.error(error);
                  });
              });
            </script>
          </li>
          <form action="">
              <div>
                <label>
                  <img src="./resources/search.PNG" id= "search" alt="search" height="30" width="30">
                </label>
                <input type="text" name="filename" placeholder="Search">
              </div>    
          </form>
        </ul>
      </div>
      <div class="sidebar">
        <ul id="fileList">

        </ul>
      </div>

      <div class="main-content">

            <div class="filePrint">
                <ul id="filePrint">

                </ul>

            </div>

            
      </div>

      <script>
        const { ipcRenderer } = require('electron');
        const fs = require('fs');

        const fileList = document.getElementById('fileList');
        const filePrint = document.getElementById('filePrint');
        const backButton = document.getElementById('backButton');
        const path = require('path');

        let currentDir = '\\';

        function updateFileList(dirPath) {
          currentDir = dirPath;
          fs.readdir(dirPath, (err, files) => {
            if (err) {
              console.error(err);
              return;
            }
          
            fileList.innerHTML = '';
            console.log('Files in directory:', dirPath);
            files.forEach(file => {
              const listItem = document.createElement('li');
              const link = document.createElement('a');
              const filePath = `${dirPath}/${file}`;  // Use '/' instead of '\\'

              fs.stat(filePath,(err,stats) => {
                if(err){
                  console.error(err);
                  return;
                }
                if(stats.isDirectory()){
                  link.setAttribute('data-type', 'directory');
                  link.innerHTML = `<img src="./resources/folder.PNG" width="50" height="50"><br>${file}`;
                }else{
                  link.setAttribute('data-type', 'file');
                  link.innerHTML = file;
                }
              })
              link.setAttribute('href', `file://${filePath}`);
              link.setAttribute('data-path', `/${filePath}`);
              listItem.appendChild(link);
              fileList.appendChild(listItem);
            });
          });
        }


        function handleLinkClick(event) {
          event.preventDefault();
          const link = event.target;
          const path = link.getAttribute('data-path');  // Use 'data-path' instead of 'href'
          const type = link.getAttribute('data-type');
          console.log('Link clicked:', path, type);

          if (type === 'file') {
            console.log(path);
            const listItem = document.createElement('li');
            listItem.innerHTML = `<img src="./resources/file.png" width="50" height="50"><br>${path}`;
            filePrint.appendChild(listItem);

          } else if (type === 'directory') {
            const listItem = document.createElement('li');
            listItem.innerHTML = `<img src="./resources/folder.PNG" width="50" height="50"><br>${path}`;
            filePrint.appendChild(listItem);
            updateFileList(path);
          }
        }

        function handleLinkDoubleClick(event) {
          event.preventDefault();
          const link = event.target;
          const path = link.getAttribute('data-path');  // Use 'data-path' instead of 'href'
          const type = link.getAttribute('data-type');
          if (type === 'directory') {
            updateFileList(path);
          }
        }

        function handleFolderSelection(event) {
          const link = event.target;
          const path = link.getAttribute('data-path');
          const type = link.getAttribute('data-type');
          if (type === 'directory') {
            filePrint.querySelectorAll('a').forEach(link => link.classList.remove('selected'));
            link.classList.add('selected');
          }
        }

        function handleBackButtonClick() {
          let currentPath;
          const selectedLink = fileList.querySelector('a.selected');

          // 如果没有选中的链接，那么我们使用当前目录作为默认值。
          if (selectedLink) {
            currentPath = selectedLink.getAttribute('data-path');
          } else {
            currentPath = currentDir;
          }
          
          const parentPath = path.dirname(currentPath);
          
          // '/' 在Windows系统中并不是根路径，应该更改为 'C:\\' 或是硬盘的具体路径。
          if(parentPath !== 'C:\\'){
            updateFileList(parentPath);
          }
        }


        document.addEventListener('DOMContentLoaded', () => {
          updateFileList('\\');
        });

        ipcRenderer.on('changeDirectory', (event, arg) => {
          updateFileList(arg);
        });

        fileList.addEventListener('click', handleLinkClick);
        fileList.addEventListener('dblclick', handleLinkDoubleClick);
        fileList.addEventListener('click', handleFolderSelection);
        backButton.addEventListener('click', handleBackButtonClick);

      </script>

        
    </div>
      
      
    
</body>
</html>